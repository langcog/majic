---
title: "MAJIC Study Analyses"
author: "Mike Frank"
date: "June 20, 2016"
output: 
  html_document:
    toc: true
    number_sections: true
    highlight: tango
    theme: spacelab
---

```{r include=FALSE}
require(knitr)
opts_chunk$set(
  cache=TRUE,
  warn=FALSE,
  error=FALSE,
  size="small"    # slightly smaller font for code
)
```

```{r}
library(readr)
library(dplyr)
library(ggplot2)
library(langcog)
library(magrittr)
library(stringr)
library(tidyr)
library(googlesheets)


rm(list=ls())
theme_set(theme_mikabr() +
            theme(panel.grid = element_blank(),
                  strip.background = element_blank()))
font <- "Open Sans"
```

# Runsheets and exclusions

```{r}
runsheet <- read_csv("data/runsheet_6-20-16.csv") %>%
  select(SID, Homeroom, Consent)

classes <- read_csv("data/classrooms_6-20-16.csv") %>%
  select(Exclude, Homeroom, Group)

kids_raw <- left_join(runsheet, classes) %>%
  mutate(Consent = ifelse(is.na(Consent), 0, Consent))

kids <- kids_raw %>%
  filter(Consent == 1, Exclude == 0) 

groups <- kids %>% 
  select(SID, Group, Homeroom) %>%
  rename(roster_subid = SID,
         room = Homeroom,
         group = Group)
```

Raw numbers.

```{r}
kable(kids_raw %>% group_by(Group, Consent) %>% summarise(n = n()))
```

By consent proportion for included rooms. 

```{r}
kable(kids_raw %>% 
        group_by(Group) %>% 
        filter(!is.na(Group), Group != "EXCLUDED") %>%
        summarise(consent = sum(Consent == 1), 
                  total = n(), 
                  prop = mean(Consent == 1)), 
      digits = 2)
```

By room.

```{r}
kable(kids_raw %>% 
        group_by(Group, Homeroom) %>% 
        filter(!is.na(Group), Group != "EXCLUDED") %>%
        summarise(consent = sum(Consent == 1), 
                  total = n(), 
                  prop = mean(Consent == 1)), 
      digits = 2)
```

Summary, we got around 50% consent rate; consent rate didn't differ across groups. 

# Cognitive tasks

Read data. Note that there is one sitting file for the battery and one for each of the sub-tests, in case the battery crashed and failed to save data for that participant.

```{r}
sittings.raw <- bind_rows(
  read_csv("data/2016/b301_06.20.16_17.00.40_sittings.csv"),
  read_csv("data/2016/b299_06.20.16_17.03.46_sittings.csv"),
  read_csv("data/2016/b300_06.20.16_17.03.52_sittings.csv"),
  read_csv("data/2016/b302_06.20.16_17.03.58_sittings.csv"))

sittings <- sittings.raw %>% 
  mutate(subid = str_trim(toupper(misc), side = "both"),
         sitting_id = id) %>%
  filter(str_detect(subid, "[Ss][12]-")) %>%
  mutate(grade = ifelse(str_detect(subid, "[Ss][1]"), 
                        "first grade", 
                        "second grade"), 
         year = factor(str_sub(start_time, 1, 4))) %>%
  select(subid, sitting_id, year, grade, battery_id, test_order, num_completed)
```

Each task has the every-battery and the one-sitting version. 

```{r}
gonogo.raw <- bind_rows(
  read_csv("data/2016/b299_t463_06.20.16_17.06.05.csv"),
  read_csv("data/2016/b301_t463_06.20.16_17.06.16.csv"))

ravens.raw <- bind_rows(
  read_csv("data/2016/b300_t464_06.20.16_17.06.12.csv"),
  read_csv("data/2016/b301_t464_06.20.16_17.06.18.csv"))

swm.raw <- bind_rows(
  read_csv("data/2016/b302_t467_06.20.16_17.06.27.csv"),
  read_csv("data/2016/b301_t467_06.20.16_17.06.19.csv"))
```

Merge in demographics. 

First, find the subjects whose IDs were entered incorrectly and output. 

```{r}
anti_join(sittings, groups %>% rename(subid = roster_subid)) %>%
  select(subid, battery_id) %>%
  write_csv("data/missing_sittings.csv")
```

Now read in the conversion table. (Done by hand by checking the runsheet for typos, notes etc, on the basis of `missing_sittings.csv`).

```{r}
missing_sittings <- read_csv("data/missing_sittings_key.csv")

sittings <- left_join(sittings, missing_sittings) %>%
  mutate(exclude = ifelse(is.na(exclude), 0, exclude)) %>%
  filter(exclude != 1) %>%
  mutate(roster_subid = ifelse(is.na(new_subid), subid, new_subid)) %>%
  left_join(groups) 
```

Computer testing numbers. Note that battery 301 is the combined battery. 

```{r}
sittings %>% 
  group_by(grade, year, battery_id) %>%
  summarise(n = n())
```

## Go / No-Go Task

```{r}
gonogo <- gonogo.raw %>%
  filter(sitting_id %in% sittings$sitting_id) %>%
  left_join(sittings, by = "sitting_id") %>%
  select(subid, year, grade, trial, stim, correct, rt, accuracy, group,
         responseAssign, rtCall)
```

Accuracy.

```{r}
gonogo.summary <- gonogo %>%
  group_by(subid, grade, group, year) %>%
  summarise(accuracy = mean(accuracy, na.rm=TRUE))
  
ms <- gonogo.summary %>%
  group_by(grade, group, year) %>%
  summarise(accuracy = mean(accuracy))

gonogo.summary %>%
  ggplot(aes(x=accuracy, fill = group)) + 
  geom_histogram(binwidth = .05) +
  facet_grid(grade ~ year) + 
  geom_vline(xintercept = .5, lty = 3) +
  xlim(c(0,1)) + 
  geom_vline(data = ms, aes(xintercept = accuracy, col = group), 
             lty = 2)

```

RT.

```{r}
ms <- gonogo %>%
  filter(rt > 0 & accuracy == 1) %>%
  group_by(subid, grade, group, year) %>%
  summarise(rt = mean(rt, na.rm=TRUE)) %>%
  group_by(grade, group) %>%
  summarise(rt = mean(rt))

gonogo %>%
  filter(rt > 0 & accuracy == 1) %>%
  group_by(subid, grade, group, year) %>%
  summarise(rt = mean(rt, na.rm=TRUE)) %>%
  ggplot(aes(x=rt, fill = group)) + 
  geom_histogram(binwidth = 50) +
  facet_grid(grade ~ year) + 
  geom_vline(data = ms, aes(xintercept = rt, col = group), 
             lty = 2)
```

## Spatial WM

Data processing. 

```{r}
swm <- swm.raw %>%
  filter(sitting_id %in% sittings$sitting_id,
         type == "test") %>%
  left_join(sittings, by = "sitting_id") %>%
  filter(type == "test") %>%
  select(subid, grade, group, year, trial, capacity, correct)
  
```

Mean level (same measure as in Zenith study). 

```{r}
swm.summary <- swm %>%
  group_by(subid, grade, group, year) %>%
  summarise(capacity = mean(capacity, na.rm=TRUE))
  
ms <- swm.summary %>%
  group_by(grade, group, year) %>%
  summarise(capacity = mean(capacity))
  
swm.summary %>%
  ggplot(aes(x=capacity, fill = group)) + 
  geom_histogram(binwidth = .5) +
  facet_grid(grade ~ year) +
  xlim(c(1,8)) +
  geom_vline(data = ms, aes(xintercept = capacity, col = group), 
             lty = 2)
```

## Raven's 

Actually a matrix reasoning equivalent.

```{r}
ravens <- ravens.raw %>%
  filter(sitting_id %in% sittings$sitting_id,
         type == "test") %>%
  left_join(sittings, by = "sitting_id") %>%
  filter(type == "test") %>%
  select(subid, grade, group, year, trial, correct)
  
```

Mean level (same measure as in Zenith study). 

```{r}
ravens.summary <- ravens %>% 
  group_by(subid, grade, group, year) %>%
    summarise(correct = sum(correct, na.rm=TRUE))

ms <- ravens.summary %>%
  group_by(grade, group, year) %>%
  summarise(correct = mean(correct))
  
ravens.summary %>%
  ggplot(aes(x=correct, fill = group)) + 
  geom_histogram(binwidth = 1) +
  facet_grid(grade ~ year) +
  geom_vline(data = ms, aes(xintercept = correct, col = group), 
             lty = 2)
```

## Summary plot

```{r}
subs <- ravens.summary %>% 
  left_join(gonogo.summary) %>%
  left_join(swm.summary) %>%
  rename(ravens = correct, 
         gonogo = accuracy,
         swm = capacity) 

ms <- subs %>%
  gather(task, score, ravens, gonogo, swm) %>%
  group_by(year, group, task) %>%
  multi_boot_standard("score", na.rm=TRUE)

pos <- position_dodge(width = .05)
ggplot(ms, aes(x = year, y = mean, col = group, group = group)) +
  geom_line(position = pos) + 
  geom_pointrange(aes(ymin = ci_lower, ymax = ci_upper), 
                  position = pos) + 
  facet_wrap(~task, scales = "free_y") + 
  scale_colour_solarized()
```

And final numbers on N data points per task. 

```{r}
kable(subs %>%
  gather(task, score, ravens, gonogo, swm) %>%
  group_by(year, group, task) %>%
  summarise(n=n()))
```

## Individual correlations

Year-by-year task plot

```{r}
subs_nona <- subs %>%
  filter(!is.na(ravens) & !is.na(gonogo) & !is.na(swm))

subs_wide <- subs_nona %>% 
  gather(task, score, ravens, gonogo, swm) %>%
  mutate(year = str_c("y", as.character(year))) %>%
  spread(year, score)

ggplot(aes(x = y2015, y = y2016, col = group), data = subs_wide) + 
  geom_point() + 
  geom_smooth(method = "lm") + 
  facet_wrap(~task, scales = "free")
```

Correlations within task.

```{r}
with(filter(subs_wide, task == "gonogo"), cor.test(y2015, y2016))
with(filter(subs_wide, task == "swm"), cor.test(y2015, y2016))
with(filter(subs_wide, task == "ravens"), cor.test(y2015, y2016))
```

Correlations across tasks for 2015.

```{r}
kable(cor(subs_nona %>% 
            filter(year == "2015") %>%
            ungroup %>% 
            select(ravens, gonogo, swm)), digits = 2)
```

Correlations across tasks for 2016.

```{r}
kable(cor(subs_nona %>% 
            filter(year == "2016") %>%
            ungroup %>% 
            select(ravens, gonogo, swm)), digits = 2)
```

# Math tasks

Read in data. 

```{r}
pv <- read.csv("data/2015/2015_PVNumerals.csv") %>%
  select(subnum, pvAvg) %>%
  rename(subid = subnum)
wg <- read.csv("data/2015/2015_WGArith.csv") %>%
  select(subnum, arithmeticTotal, arithmeticAverage) %>%
  rename(subid = subnum)
wj <- read.csv("data/2015/2015_WOODCOCK.csv") %>%
  select(subnum, woodcockTotal) %>%
  rename(subid = subnum)
```

Merge with sub data. 

```{r}
d <- left_join(subs, pv) %>% 
  left_join(wg) %>% 
  left_join(wj)
```

Now plot each task individually. 

## Place value

```{r}
pv.summary <- d %>% 
  group_by(subid, grade) %>%
    summarise(correct = sum(pvAvg, na.rm=TRUE))

ms <- pv.summary %>%
  group_by(grade) %>%
  summarise(correct = mean(correct))
  
pv.summary %>%
  ggplot(aes(x=correct)) + 
  geom_histogram(binwidth = .1) +
  facet_grid(.~grade) +
  geom_vline(data = ms, aes(xintercept = correct), 
             col = "red", lty = 2) + 
  ggtitle("Place Value Accuracy") + 
  xlab("Proportion correct")
```

## Arithmetic

```{r}
wg.summary <- d %>% 
  group_by(subid, grade) %>%
    summarise(correct = sum(arithmeticTotal, na.rm=TRUE))

ms <- wg.summary %>%
  group_by(grade) %>%
  summarise(correct = mean(correct))
  
wg.summary %>%
  ggplot(aes(x=correct)) + 
  geom_histogram(binwidth = 1) +
  facet_grid(.~grade) +
  geom_vline(data = ms, aes(xintercept = correct), 
             col = "red", lty = 2) + 
  ggtitle("Arithmetic Accuracy") + 
  xlab("Total Problems Correct")
```

## Woodcock-Johnson III

```{r}
wj.summary <- d %>% 
  group_by(subid, grade) %>%
    summarise(correct = sum(woodcockTotal, na.rm=TRUE))

ms <- wj.summary %>%
  group_by(grade) %>%
  summarise(correct = mean(correct))
  
wj.summary %>%
  ggplot(aes(x=correct)) + 
  geom_histogram(binwidth = 1) +
  facet_grid(.~grade) +
  geom_vline(data = ms, aes(xintercept = correct), 
             col = "red", lty = 2) + 
  ggtitle("Woodcock-Johnson III Accuracy") + 
  xlab("Total Problems Correct")
```

## Relations between math measures

Correlations.

```{r}
kable(cor(d %>% ungroup %>% 
            select(woodcockTotal, arithmeticTotal, pvAvg)), digits = 2)

cor.test(d$woodcockTotal, d$arithmeticTotal)
cor.test(d$woodcockTotal, d$pvAvg)
cor.test(d$arithmeticTotal, d$pvAvg)
```

# Relations between all measures

```{r}
kable(cor(d %>% ungroup %>% 
            select(ravens, gonogo, swm, 
                   woodcockTotal, arithmeticTotal, pvAvg)), digits = 2)

cor.test(d$ravens, d$woodcockTotal)
cor.test(d$ravens, d$arithmeticTotal)
cor.test(d$ravens, d$pvAvg)

cor.test(d$swm, d$woodcockTotal)
cor.test(d$swm, d$arithmeticTotal)
cor.test(d$swm, d$pvAvg)

cor.test(d$gonogo, d$woodcockTotal)
cor.test(d$gonogo, d$arithmeticTotal)
cor.test(d$gonogo, d$pvAvg)
```